const fs=require('fs'),p=require('path');try{const f={{FILE_PATH}},i={{CHUNK_INDEX}},d={{CHUNK_DATA}},t={{TOTAL_CHUNKS}};if(!f||typeof f!=='string')throw new Error('Invalid path');if(typeof i!=='number'||i<0)throw new Error('Invalid index');if(!d||typeof d!=='string')throw new Error('Invalid data');if(typeof t!=='number'||t<=0)throw new Error('Invalid total');const target=p.resolve(f),dir=p.dirname(target);if(!fs.existsSync(dir))fs.mkdirSync(dir,{recursive:true});const buf=Buffer.from(d,'base64'),tmp=target+'.tmp';if(i===0)fs.writeFileSync(tmp,buf);else fs.appendFileSync(tmp,buf);if(i===t-1){fs.renameSync(tmp,target);console.log(JSON.stringify({ok:true,path:target,chunkIndex:i,totalChunks:t,chunk_index:i,total_chunks:t,message:'ok'}));}else{console.log(JSON.stringify({ok:true,path:target,chunkIndex:i,totalChunks:t,chunk_index:i,total_chunks:t,message:'chunk ok'}));}}catch(e){console.log(JSON.stringify({ok:false,error:String(e.message||e),chunkIndex:typeof i!=='undefined'?i:-1}));}
