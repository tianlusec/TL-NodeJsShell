name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            goos: linux
            goarch: amd64
            ext: ""
          - os: windows
            arch: amd64
            goos: windows
            goarch: amd64
            ext: ".exe"
          - os: darwin
            arch: amd64
            goos: darwin
            goarch: amd64
            ext: ""
          - os: darwin
            arch: arm64
            goos: darwin
            goarch: arm64
            ext: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache-dependency-path: server/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install rsrc (Windows only)
        if: matrix.goos == 'windows'
        run: go install github.com/akavel/rsrc@latest

      - name: Generate Windows Icon Resource
        if: matrix.goos == 'windows'
        run: |
          # Assuming logo.ico is in docs/images/logo.ico based on previous steps
          if [ -f "docs/images/logo.ico" ]; then
            rsrc -ico docs/images/logo.ico -o server/cmd/api/rsrc_windows.syso
          fi

      - name: Build Frontend
        working-directory: ./web
        run: |
          npm install
          npm run build

      - name: Build Backend
        working-directory: ./server
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          go mod tidy
          go build -o NodeJsshell${{ matrix.ext }} ./cmd/api

      - name: Prepare Artifact
        run: |
          mkdir -p release/web/dist
          cp -r web/dist/* release/web/dist/
          mv server/NodeJsshell${{ matrix.ext }} release/
          
          # Create archive
          cd release
          if [ "${{ matrix.goos }}" == "windows" ]; then
            zip -r ../NodeJsshell_${{ matrix.goos }}_${{ matrix.goarch }}.zip .
          else
            tar -czvf ../NodeJsshell_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz .
          fi

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: NodeJsshell_${{ matrix.goos }}_${{ matrix.goarch }}*
            NodeJsshell_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz
